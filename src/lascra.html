<!DOCTYPE HTML>
<html>
	<head>
		<title>Lascra</title>
		<style>
			#log { font-family: monospace; }
		</style>
	</head>
	<body>
		<h2>Lascra (Lisp and Scratch)</h2>
		<br/>
		<label for="sprite">Sprite File:</label>
		<input type="file" id="sprite"/>
		<br/>
		<label for="remove">Code Removal Level:</label>
		<select id="remove">
			<option value="lascra">Remove lascra-generated code</option>
			<option value="keep">Keep all code</option>
			<option value="erase">Erase all code</option>
		</select>
		<br/>
		<input type="checkbox" id="sb3" name="sb3"/>
		<label for="sb3">Process Sprite File as sb3 instead of sprite3</label>
		<br/>
		<label for="name">sb3 sprite name</label>
		<input type="text" id="name" name="name"/>
		<br/>
		<label for="code">Lascra Code Files:</label>
		<input type="file" id="code" name="code" multiple/>
		<br/>
		<button type="button" id="compile">Compile!</button>
		<span id="result">Try Compiling!</span>
		<br/>
		<a id="download" style="display: none">Download!</a>
		<h3>Lascra Output</h3>
		<span id="log"></span>
		<br/>
		<button type="button" id="help">Display Help Message</button>
		<script>
// Override console.log
(function () {
    var old = console.log;
    var logger = document.getElementById('log');
    console.log = function () {
      for (var i = 0; i < arguments.length; i++) {
        if (typeof arguments[i] == 'object') {
            logger.innerHTML += (JSON && JSON.stringify ? JSON.stringify(arguments[i], undefined, 2) : arguments[i]) + '<br />';
        } else {
            logger.innerHTML += arguments[i] + '<br />';
        }
      }
    }
})();
		</script>
		<!-- Import Lascra WebAssembly Module -->
		<script src="lascra.js"></script>
		<script>
// Lascra Javascript
const sprite = document.getElementById("sprite");
const remove = document.getElementById("remove");
const sb3 = document.getElementById("sb3");
const name = document.getElementById("name");
const code = document.getElementById("code");
const compile = document.getElementById("compile");
const result = document.getElementById("result");
const download = document.getElementById("download");
const help = document.getElementById("help");
// Read Sprite3 File with FileReader API
sprite.addEventListener("change", (event) => {
	download.download = event.target.files[0].name;
	const reader = new FileReader();
	reader.onload = (event) => {
		const arrayBuffer = event.target.result;
		const byteArray = new Uint8Array(arrayBuffer);
		FS.writeFile("sprite", byteArray);
	};
	reader.readAsArrayBuffer(event.target.files[0]);
});
// Compile Sprite
async function lascra(event) {
	let args = ["sprite"];
	if (sb3.checked) {
		args.push("-s");
		args.push(name.value || "sprite");
	}
	if (remove.value == "keep") args.push("-k");
	else if (remove.value == "erase") args.push("-e");
	for (let file = 0; file < code.files.length; file++) {
		// Convert all DOS line endings to UNIX line endings
		FS.writeFile(code.files[file].name, (await code.files[file].text()).replace(/\r\n/g, '\n'));
		args.push(code.files[file].name);
		// std::ifstream text mode does not work correctly with emscripten
	}
	// Clear Log
	document.getElementById("log").innerHTML = "";
	// Compile Sprite
	let ret = Module.callMain(args);
	// Update Page
	if (ret == 0) {
		result.textContent = "Compiled!";
		// Update Download Link
		var url = URL.createObjectURL(new Blob([FS.readFile("sprite").buffer], {type: 'application/octet-stream'}));
		download.href = url;
		download.style = "display: block";
	}
	else result.textContent = "Error!";
}
compile.addEventListener("click", lascra);
// Help Message
help.addEventListener("click", (event) => {
	// Clear Log
	document.getElementById("log").innerHTML = "";
	// Call Main
	Module.callMain(["-h"]);
});
		</script>
	</body>
</html>
